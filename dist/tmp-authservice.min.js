var Authservice=function(){function e(e){return"bob"==e?L:null}function t(e,t,r,o,n){var a=C+t;if(console.log("authservice_ajax_call(method, "+t+")"),console.log(a),console.log(r),console.log("vvvvvv calling vvvvvv"),J){console.log("*** Using Angular AJAX call");J({method:"POST",url:a,data:r}).then(function(e){var t=e.data;return console.log("success:",t),o(t)},function(e){var t=e.status,r=e.statusText,a=e.data;return n?n(t,r,a):(alert("An error occurred contacting Authservice.\nSee the Javascript console for details."),console.log("statusCode:",e),console.log("statusText:",r),console.log("error:",a),o(null))})}else{console.log("*** jQuery AJAX call (before)");var i=JSON.stringify(r);$.ajax({url:a,type:"POST",crossDomain:!0,async:!0,data:i,dataType:"json",contentType:"application/json",success:function(e){return console.log("*** jQuery AJAX call (success)"),o(e)},error:function(e,t,r){console.log("*** jQuery AJAX call (error)");var a=e.status,i=e.statusText,s=r;return n?n(a,i,s):(alert("An error occurred contacting Authservice.\nSee the Javascript console for details."),console.log("statusCode:",a),console.log("statusText:",i),console.log("error:",s),o(null))}})}}function r(e){var t=RegExp("[?&]"+e+"=([^&]*)").exec(window.location.search);return t&&decodeURIComponent(t[1].replace(/\+/g," "))}function o(){var e=r("AUTHSERVICE_JWT");if(e){console.log("***"),console.log("***"),console.log("*** AUTHSERVICE_JWT IN URL"),console.log("***"),console.log("***");var t=!1;return void(c(e,t)?v(A,e,S):g(A))}var e=h(A);if(e){console.log("***"),console.log("***"),console.log("*** AUTHSERVICE_JWT IN A COOKIE"),console.log("***"),console.log("***");var t=!1;return void(c(e,t)||g(A))}console.log("***"),console.log("***"),console.log("*** AUTHSERVICE_JWT NOT IN URL OR COOKIE"),console.log("***"),console.log("***");var t=!1;u(null,null,t)}function n(){if(O){var e={user:{id:O.id,fullname:O.fullname,avatar:O.avatar,firstname:O.firstname,lastname:O.lastname},ttuat:E};console.log("Setting "+k+" (not sure why)"),v(k,JSON.stringify(e),S)}else console.log("Removing "+k+" (no current user)"),v(k,null,0)}function a(){return O}function i(){return O?O.id:0}function s(){return E}function u(e,t,r){if(e){if(O=e,P=e.id,t&&(E=t),n(),$(".authservice-logged-in").show(),$(".authservice-logged-out").hide(),$(".authservice-current-user-firstname").text(e.firstname),$(".authservice-current-user-lastname").text(e.lastname),e.avatar?($(".authservice-current-user-avatar").attr("src",e.avatar).show(),$(".authservice-default-user-avatar").attr("src",e.avatar).hide()):($(".authservice-current-user-avatar").attr("src",e.avatar).hide(),$(".authservice-default-user-avatar").attr("src",e.avatar).show()),I){var o=a(),i=E;I(o,i,r)}}else if(O=null,P=-1,E=null,n(),$(".authservice-logged-in").hide(),$(".authservice-logged-out").show(),$(".authservice-current-user-firstname").text(""),$(".authservice-current-user-lastname").text(""),$(".authservice-current-user-avatar").attr("src","").hide(),I){var r=!1;I(null,null,r)}}function c(e,t){var r=!1;if(e)try{var o=jwt_decode(e);console.log(o);var n=o.identity;r=!0}catch(e){alert("Error decoding invalid JWT"),r=!1}if(r){var i={authority:n.authority,avatar:n.avatar,email:n.email,entityType:n.entity_type,firstname:n.first_name,fullname:n.full_name,gender:n.gender,id:n.id,isAdmin:n.is_admin,languages:n.languages,lastname:n.last_name,locale:n.locale,location:n.location,mediaPage:n.media_page,middlename:n.middle_name,privileges:n.privileges,status:n.status,timezone:n.timezone};if(console.log("Setting _currentUser to ",i),O=i,P=n.id,E=e,_jwt=e,$(".authservice-logged-in").show(),$(".authservice-logged-out").hide(),$(".authservice-current-user-firstname").text(i.firstname),$(".authservice-current-user-lastname").text(i.lastname),i.avatar?($(".authservice-current-user-avatar").attr("src",i.avatar).show(),$(".authservice-default-user-avatar").attr("src",i.avatar).hide()):($(".authservice-current-user-avatar").attr("src",i.avatar).hide(),$(".authservice-default-user-avatar").attr("src",i.avatar).show()),I){var s=a();I(s,E,t)}return!0}if(O=null,P=-1,E=null,_jwt=null,console.log("Removing "+k+" (not sure why)"),v(k,null,0),$(".authservice-logged-in").hide(),$(".authservice-logged-out").show(),$(".authservice-current-user-firstname").text(""),$(".authservice-current-user-lastname").text(""),$(".authservice-current-user-avatar").attr("src","").hide(),I){var t=!1;I(null,null,t)}return!1}function v(e,t,r){console.log("setCookie("+e+")");var o=new Date;o.setTime(o.getTime()+24*r*60*60*1e3);var n="expires="+o.toUTCString();document.cookie=e+"="+t+";"+n+";path=/"}function g(e){console.log("removeCookie("+e+")"),v(e,null,0)}function h(e){for(var t=e+"=",r=document.cookie.split(";"),o=0;o<r.length;o++){for(var n=r[o];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""}function d(e){var t={id:e.id,authority:e.authority,avatar:e.avatar,fullname:e.full_name,status:e.status,type:e.type};return"user"==t.type&&(t.locale=e.user.locale,t.location=e.user.location,t.timezone=e.user.timezone,t.firstname=e.user.user_first_name,t.gender=e.user.user_gender,t.languages=e.user.user_languages,t.lastname=e.user.user_last_name,t.mediaPage=e.user.user_media_page,t.middlename=e.user.user_middle_name),t.properties=e.properties,t.propertySummary=e.propertySummary,t.relationships=e.relationships,t.relationshipSummary=e.relationshipSummary,t}function m(e){if("string"==typeof e)var t=e,r=null,o=null;else var t=e.authority,r=e.resume?e.resume:null,o=e.error?e.error:null;if(!t)return void alert("authservice.initiateOAuth2(): missing 'authority' parameter");r||(r=w()),o||(o=r),console.log("successURL="+r),console.log("successURL="+encodeURIComponent(r)),console.log("failURL="+o);var n="http://"+T+":"+U+"/v2/oauth2/initiate/"+b+"/"+t;n+="?success="+encodeURIComponent(r),n+="&fail="+encodeURIComponent(o),window.location=n}function f(){return g(A),u(null,null,!1),authservice.resetLoginMenu(),!1}function p(e,r,o){var n=e.email,a=(e.username,e.password),i=e.first_name,s=e.middle_name,l=e.last_name,u=e.resume;if(x)return console.log("seems we are pretending"),r();if(null==n||n.indexOf("@")<1)return o("Please enter a valid email address");var c={email:n,username:n,resume:u};if(a){if(a.length<5)return o("Please enter a longer password");c.password=a}if(i){if(i.length<5)return o("Please enter a first name");c.first_name=i}if(s&&s.length>0&&(c.middle_name=s),l){if(l.length<1)return o("Please enter a last name");c.last_name=l}console.log("params=",c),t("POST","/email/register",c,function(e){if(console.log("response is ",e),e&&"ok"==e.status){if(r)return r()}else{var t=e&&e.message?e.message:"Error while registering";if(o)return o(t)}})}function _(){var e=r("AUTHSERVICE_JWT");e&&(console.log("*** setting JWT cookie"),v(A,e,S));var t=r("resume");console.log("Redirect to "+t),alert("about to redirect"),r("debug")||(window.location=t)}function y(e,t){return t||(t=w()),l=window.location,l.protocol+"//"+l.host+e+"?resume="+encodeURIComponent(t)}function w(){l=window.location;var e=l.search;return""!=e&&(e="&"+e.substring(1),""!=(e=e.replace(/&AUTHSERVICE_JWT=[^&]*/,"").replace(/&AUTHSERVICE_ERROR=[^&]*/,""))&&(e="?"+e.substring(1))),l.protocol+"//"+l.host+l.pathname+e+l.hash}var T,U,R,b,k="authservice-login-details",A="authservice-jwt",S=3,C=null,P=-1,O=null,E=null,J=null,x=!1,I=null,L={tenant:"nodeclient",id:901,authority:"email",type:"user",external_id:"jim",status:"new",email:"Bob",email_status:"",full_name:"Bob the Builder",avatar:"",entity_type_description:"User",is_login_account:1,user:{locale:"",location:"",timezone:"",user_first_name:"Bob",user_gender:"male",user_languages:"EN",user_last_name:"Builder",user_media_page:"",user_middle_name:"B"},relationshipSummary:{isFriendedBy:[{entity_id:902,full_name:"Jim Boots",last_name:"Boots",entity_type:"user"}],hasFriend:[{entity_id:903,full_name:"Jill Jones",last_name:"Jones",entity_type:"user"}]},relationships:[{relationship_id:6,relationship_type:"friend",entity_id_1:901,entity_id_2:902}]};return{register:p,logout:f,setCookie:v,getCookie:h,getCurrentUser:a,getCurrentUserId:i,getUserAccessToken:s,initiateOAuth2:m,bounce:_,bounceURL:y,currentPageURL:w,init:function(e){console.log("authservice.init()",e),T=e.host?e.host:"authservice.io",U=e.port?e.port:80,R=e.version?e.version:"v1",b=e.tenant,C="//"+T+":"+U+"/"+R+"/"+b,e.$http&&(J=e.$http),e.onUserChange&&(I=e.onUserChange),x=!!e.pretend,o(),$("#authservice-login-button").click(function(){return $("#authservice-login-div").show(),$("#authservice-forgot-div").hide(),$("#authservice-register-div").hide(),!1}),$("#authservice-forgot-button").click(function(){return $("#authservice-login-button").hide(),$("#authservice-login-div").hide(),$("#authservice-forgot-div").show(),$("#authservice-register-button").hide(),$("#authservice-register-div").hide(),!1}),$("#authservice-register-button").click(function(){return $("#authservice-login-button").hide(),$("#authservice-login-div").hide(),$("#authservice-forgot-button").hide(),$("#authservice-forgot-div").hide(),$("#authservice-register-div").show(),!1}),$("#authservice-forgot-cancel").click(authservice.resetLoginMenu),$("#authservice-forgot-ok").click(authservice.resetLoginMenu),$("#authservice-register-cancel").click(authservice.resetLoginMenu),$("#authservice-register-ok").click(authservice.resetLoginMenu),$("#authservice-logout-button").click(function(){authservice.logout()}),$("#authservice-login-submit").click(function(){var e=$("#authservice-login-username").val(),t=$("#authservice-login-password").val();authservice.login(e,t,function(e){authservice.resetLoginMenu()},function(){$("#authservice-login-errmsg").show()})}),$("#authservice-forgot-submit").click(function(){var e=$("#authservice-forgot-username").val();alert("forgot("+e+")");var t=!1;return"ok"==e&&(t=!0),t?($("#authservice-forgot-email2").val(e),$("#authservice-forgot-button").hide(),$("#authservice-forgot-div").hide(),$("#authservice-forgot-done").show(),!1):($("#authservice-forgot-errmsg").show(),!1)}),$("#authservice-register-submit").click(function(){var e=($("#authservice-register-username").val(),$("#authservice-register-password").val()),t=!1;return"ok"==e&&(t=!0),t?($("#authservice-register-button").hide(),$("#authservice-register-div").hide(),$("#authservice-register-done").show(),!1):($("#authservice-register-errmsg").show(),!1)})},login:function(r,o,n,a){if(console.log("authservice.login(username="+r+")"),x){console.log("seems we are pretending");var i=e(r);return u(i,null,!1),n(i)}t("POST","/login",{username:r,password:o},function(e){if(console.log("authservice.login() back from AJAX call with",e),"ok"==e.status){console.log("Back from login:",e);var t=e.jwt;if(c(t,!1)?v(A,t,S):g(A),n)return n(O)}else{var r=e.message;if(a)return a(e.message);alert("Login error:"+r)}},function(e,t,r){if(console.log("Login failed: ",e,t,r),a)return a(t)})},reloadUser:function(r){if(alert("authservice.reloadUser()"),console.log("reloadUser"),null==O){var o=null,n=null,a=!1;u(o,n,a),r&&r(null)}if(x){console.log("reloading dummy data");var o=e(O.username),n=null;return u(o,n,!1),r(o)}t("POST","/getIdentityWithAuthtoken",{ttuat:E,needRelationships:!0,needProperties:!0},function(e){if(console.log("back from /getIdentityWithAuthtoken ",e),e&&e.length>0){console.log("User details reloaded.");var t=d(e[0]),o=E,n=!1;u(t,o,n),r&&r(t)}else console.log("Could not reload user. Must have timed out."),u(null,null,n),r&&r(null)},function(e,t,o){console.log("Was not able to reload the user:",e,t,console.error),u(null,null,a),r&&r(null)})},resetLoginMenu:function(){return $("#authservice-login-button").show(),$("#authservice-login-div").show(),$("#authservice-forgot-button").show(),$("#authservice-forgot-div").hide(),$("#authservice-forgot-ok").hide(),$("#authservice-register-button").show(),$("#authservice-register-div").hide(),$("#authservice-register-ok").hide(),$("#authservice-login-username").val(""),$("#authservice-login-password").val(""),$("#authservice-forgot-username").val(""),$("#authservice-register-username").val(""),$("#authservice-register-password").val(""),$("#authservice-user-dropdown").parent().removeClass("open"),!0},getUser:function(e,r){console.log("getUser()"),t("POST","/admin/getUser",e,r)},addRelationship:function(e,r){console.log("addRelationship()"),t("POST","/admin/addRelationship",e,r)},removeRelationship:function(e,r){console.log("removeRelationship()"),t("POST","/admin/removeRelationship",e,r)},addProperty:function(e,r){console.log("addProperty()"),t("POST","/admin/addProperty",e,r)},removeProperty:function(e,r){console.log("removeProperty()"),t("POST","/admin/removeProperty",e,r)},nocomma:null}}(),authservice=Authservice;