var Authservice=function(){function e(e){return"bob"==e?z:null}function r(e,r,t,o,n,a){var s=P+r;if(console.log("authservice_ajax_call(method, "+r+")"),console.log(s),console.log(t),console.log("vvvvvv calling vvvvvv"),a?console.log("------- have errorCallback"):console.log("------- no errorCallback"),N){console.log("*** Using Angular AJAX call");var i={method:e,url:s,data:t};o&&(i.headers={Authorization:"Bearer XYZ"}),N(i).then(function(e){var r=e.data;return console.log("success:",r),n(r)},function(e){var r=e.status,t=e.statusText,o=e.data;return a?a(r,t,o):(alert("An error occurred contacting Authservice.\nSee the Javascript console for details."),console.log("statusCode:",e),console.log("statusText:",t),console.log("error:",error),n(null))})}else{console.log("*** jQuery AJAX call (before)");var l={};o&&(l.Authorization="Bearer XYZ");var u=JSON.stringify(t);$.ajax({url:s,type:e,crossDomain:!0,async:!0,data:u,dataType:"json",headers:l,contentType:"application/json",success:function(e){return console.log("*** jQuery AJAX call (success)",e),n(e)},error:function(e,r,t){console.log("*** jQuery AJAX call (error)",e,r,t);var o=e.status,n=e.statusText,s=e.responseJSON;if(a)return a(o,n,s);alert("An error occurred contacting Authservice.\nSee the Javascript console for details."),console.log("statusCode:",o),console.log("statusText:",n),console.log("responseJSON:",s)}})}}function t(e){var r=RegExp("[?&]"+e+"=([^&]*)").exec(window.location.search);return r&&decodeURIComponent(r[1].replace(/\+/g," "))}function o(){var e=t("AUTHSERVICE_JWT");if(e){console.log("***"),console.log("***"),console.log("*** AUTHSERVICE_JWT IN URL"),console.log("***"),console.log("***");var r=!1;return void(c(e,r)?g(C,e,J):v(C))}var e=d(C);if(e){console.log("***"),console.log("***"),console.log("*** AUTHSERVICE_JWT IN A COOKIE"),console.log("***"),console.log("***");var r=!1;return void(c(e,r)||v(C))}console.log("***"),console.log("***"),console.log("*** AUTHSERVICE_JWT NOT IN URL OR COOKIE"),console.log("***"),console.log("***");var r=!1;u(null,null,r)}function n(){if(I){var e={user:{id:I.id,fullname:I.fullname,avatar:I.avatar,firstname:I.firstname,lastname:I.lastname},ttuat:L};console.log("Setting "+R+" (not sure why)"),g(R,JSON.stringify(e),J)}else console.log("Removing "+R+" (no current user)"),g(R,null,0)}function a(){return I}function s(){return I?I.id:0}function i(){return L}function u(e,r,t){if(e){if(I=e,j=e.id,r&&(L=r),n(),M&&($(".authservice-logged-in").show(),$(".authservice-logged-out").hide(),$(".authservice-current-user-firstname").text(e.firstname),$(".authservice-current-user-lastname").text(e.lastname),e.avatar?($(".authservice-current-user-avatar").attr("src",e.avatar).show(),$(".authservice-default-user-avatar").attr("src",e.avatar).hide()):($(".authservice-current-user-avatar").attr("src",e.avatar).hide(),$(".authservice-default-user-avatar").attr("src",e.avatar).show())),W){var o=a(),s=L;W(o,s,t)}}else if(I=null,j=-1,L=null,n(),M&&($(".authservice-logged-in").hide(),$(".authservice-logged-out").show(),$(".authservice-current-user-firstname").text(""),$(".authservice-current-user-lastname").text(""),$(".authservice-current-user-avatar").attr("src","").hide()),W){var t=!1;W(null,null,t)}}function c(e,r){var t=!1;if(e)try{var o=jwt_decode(e);console.log(o);var n=o.identity;t=!0}catch(e){console.log("Error decoding JWT: ",e),alert("Error decoding invalid JWT"),t=!1}if(t){var s={authority:n.authority,avatar:n.avatar,email:n.email,entityType:n.entity_type,firstname:n.first_name,fullname:n.full_name,gender:n.gender,id:n.id,isAdmin:n.is_admin,languages:n.languages,lastname:n.last_name,locale:n.locale,location:n.location,mediaPage:n.media_page,middlename:n.middle_name,privileges:n.privileges,status:n.status,timezone:n.timezone};if(console.log("Setting _currentUser to ",s),I=s,j=n.id,L=e,_jwt=e,M&&($(".authservice-logged-in").show(),$(".authservice-logged-out").hide(),$(".authservice-current-user-firstname").text(s.firstname),$(".authservice-current-user-lastname").text(s.lastname),s.avatar?($(".authservice-current-user-avatar").attr("src",s.avatar).show(),$(".authservice-default-user-avatar").attr("src",s.avatar).hide()):($(".authservice-current-user-avatar").attr("src",s.avatar).hide(),$(".authservice-default-user-avatar").attr("src",s.avatar).show())),W){var i=a();W(i,L,r)}return!0}if(I=null,j=-1,L=null,_jwt=null,console.log("Removing "+R+" (not sure why)"),g(R,null,0),M&&($(".authservice-logged-in").hide(),$(".authservice-logged-out").show(),$(".authservice-current-user-firstname").text(""),$(".authservice-current-user-lastname").text(""),$(".authservice-current-user-avatar").attr("src","").hide()),W){var r=!1;W(null,null,r)}return!1}function g(e,r,t){console.log("setCookie("+e+")");var o=new Date;o.setTime(o.getTime()+24*t*60*60*1e3);var n="expires="+o.toUTCString();document.cookie=e+"="+r+";"+n+";path=/"}function v(e){console.log("removeCookie("+e+")"),g(e,null,0)}function d(e){for(var r=e+"=",t=document.cookie.split(";"),o=0;o<t.length;o++){for(var n=t[o];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(r))return n.substring(r.length,n.length)}return""}function h(e){var r={id:e.id,authority:e.authority,avatar:e.avatar,fullname:e.full_name,status:e.status,type:e.type};return"user"==r.type&&(r.locale=e.user.locale,r.location=e.user.location,r.timezone=e.user.timezone,r.firstname=e.user.user_first_name,r.gender=e.user.user_gender,r.languages=e.user.user_languages,r.lastname=e.user.user_last_name,r.mediaPage=e.user.user_media_page,r.middlename=e.user.user_middle_name),r.properties=e.properties,r.propertySummary=e.propertySummary,r.relationships=e.relationships,r.relationshipSummary=e.relationshipSummary,r}function m(e){if("string"==typeof e)var r=e,t=null,o=null;else var r=e.authority,t=e.resume?e.resume:null,o=e.error?e.error:null;if(!r)return void alert("authservice.initiateOAuth2(): missing 'authority' parameter");t||(t=b()),o||(o=t),console.log("successURL="+t),console.log("successURL="+encodeURIComponent(t)),console.log("failURL="+o);var n="http://"+S+":"+O+"/v2/oauth2/initiate/"+E+"/"+r;n+="?success="+encodeURIComponent(t),n+="&fail="+encodeURIComponent(o),window.location=n}function f(t,o,n,a){if(console.log("authservice.login(username="+t+")"),B){console.log("seems we are pretending");var s=e(t);return u(s,null,!1),n(s)}r("POST","/email/login",{email:t,password:o},x,function(e){if(console.log("authservice.login() back from AJAX call with",e),"ok"==e.status){console.log("Back from login:",e);var r=e.jwt;if(c(r,!1)?g(C,r,J):v(C),n)return n(I)}else{var t=e.message;if(a)return a(e.message);alert("Login error:"+t)}},function(e,r,t){if(console.log("Login failed: ",e,r,t),a)return a(t&&t.message?t.message:r)})}function p(){return v(C),u(null,null,!1),authservice.resetLoginMenu(),!1}function y(e,t,o){var n=e.email,a=e.username,s=e.password,i=e.first_name,l=e.middle_name,u=e.last_name,d=e.resume;if(B)return console.log("seems we are pretending"),t();if(null==n||n.indexOf("@")<1)return o("Please enter a valid email address");var h={email:n,resume:d};if(a){if(a=a.trim().toLowerCase(),a.indexOf(" ")>=0)return o("Username may not contain spaces");if(a.indexOf("@")>=0)return o("Username may not contain @");h.username=a}else h.username=n;if(s){if(s.length<5)return o("Please enter a longer password");h.password=s}if(i){if(i.length<1)return o("Please enter a first name");h.first_name=i}if(l&&(h.middle_name=l),u){if(u.length<1)return o("Please enter a last name");h.last_name=u}console.log("params=",h),r("PUT","/email/register",h,x,function(e){if(console.log("response is ",e),e&&"ok"==e.status){if(e.jwt){var r=e.jwt;c(r,!1)?g(C,r,J):v(C)}if(t)return t()}else{var n=e&&e.message?e.message:"Error while registering";if(o)return o(n)}},function(e,r,t){var n=t&&t.Error?t.Error:"Error while registering";if(o)return o(n)})}function _(e,t,o){var n=e.email,a=e.resume;if(B)return console.log("seems we are pretending"),t();if(null==n||n.indexOf("@")<1)return o("Please enter a valid email address");var s={email:n,resume:a};console.log("params=",s),r("POST","/email/forgot",s,x,function(e){if(console.log("response is ",e),e&&"ok"==e.status){if(t)return t()}else{var r=e&&e.message?e.message:"Error while sending email";if(o)return o(r)}})}function w(e,r,t){if(console.log("updateUser()",e),!e.id)return t("user.id not provided to Authservice.updateUser()");if(B)return console.log("seems we are pretending"),r();console.log("user=",e);var o=JSON.stringify(e);$.ajax({url:P+"/user",type:"POST",crossDomain:!0,async:!0,data:o,dataType:"json",headers:{Authorization:"Bearer "+_jwt},contentType:"application/json",success:function(e){if(console.log("Authservice.updateUser() success",e),e&&"ok"==e.status&&e.jwt){var t=e.jwt;c(t,!1)?g(C,t,J):v(C)}return r(e)},error:function(e,r,o){return console.log("Authservice.updateUser() failed",e,r,o),e.responseJSON&&e.responseJSON.Error?(console.log("Error is ",e.responseJSON.Error),t(e.responseJSON.Error)):t("Update failed")}})}function T(e,r,t){if(console.log("usernameAvailability()",e),B)return console.log("seems we are pretending"),r(!0);e=e.trim().toLowerCase();var o=P+"/username-availability/"+encodeURIComponent(e);console.log("url=",o),$.ajax({url:o,type:"GET",crossDomain:!0,async:!0,dataType:"json",contentType:"application/json",success:function(e){return console.log("Authservice.usernameAvailability() success",e),r(e&&"available"==e.status?null:e.error)},error:function(e,r,o){return console.log("Authservice.usernameAvailability() failed",e,r,o),e.responseJSON&&e.responseJSON.Error?(console.log("Error is ",e.responseJSON.Error),t(e.responseJSON.Error)):t("Could not check availability")}})}function U(){var e=t("AUTHSERVICE_JWT");e&&(console.log("*** setting JWT cookie"),g(C,e,J));var r=t("resume");console.log("Redirect to "+r),t("debug")||(window.location=r)}function A(e,r){return r||(r=b()),l=window.location,l.protocol+"//"+l.host+e+"?resume="+encodeURIComponent(r)}function b(){l=window.location;var e=l.search;return""!=e&&(e="&"+e.substring(1),""!=(e=e.replace(/&AUTHSERVICE_JWT=[^&]*/,"").replace(/&AUTHSERVICE_ERROR=[^&]*/,""))&&(e="?"+e.substring(1))),l.protocol+"//"+l.host+l.pathname+e+l.hash}var S,O,k,E,R="authservice-login-details",C="authservice-jwt",J=3,x=!1,P=null,j=-1,I=null,L=null,N=null,B=!1,W=null,M=!1,z={tenant:"nodeclient",id:901,authority:"email",type:"user",external_id:"jim",status:"new",email:"Bob",email_status:"",full_name:"Bob the Builder",avatar:"",entity_type_description:"User",is_login_account:1,user:{locale:"",location:"",timezone:"",user_first_name:"Bob",user_gender:"male",user_languages:"EN",user_last_name:"Builder",user_media_page:"",user_middle_name:"B"},relationshipSummary:{isFriendedBy:[{entity_id:902,full_name:"Jim Boots",last_name:"Boots",entity_type:"user"}],hasFriend:[{entity_id:903,full_name:"Jill Jones",last_name:"Jones",entity_type:"user"}]},relationships:[{relationship_id:6,relationship_type:"friend",entity_id_1:901,entity_id_2:902}]};return{login:f,usernameAvailability:T,register:y,forgot:_,logout:p,updateUser:w,setCookie:g,getCookie:d,getCurrentUser:a,getCurrentUserId:s,getUserAccessToken:i,initiateOAuth2:m,bounce:U,bounceURL:A,currentPageURL:b,init:function(e){console.log("authservice.init()",e),S=e.host?e.host:"authservice.io",O=e.port?e.port:80,k=e.version?e.version:"v2",E=e.tenant,P="//"+S+":"+O+"/"+k+"/"+E,console.log("endpoint = "+P),e.$http&&(N=e.$http),e.onUserChange&&(W=e.onUserChange),e.bindToDOM&&(M=e.bindToDOM),B=!!e.pretend,o(),M&&($("#authservice-login-button").click(function(){return $("#authservice-login-div").show(),$("#authservice-forgot-div").hide(),$("#authservice-register-div").hide(),!1}),$("#authservice-forgot-button").click(function(){return $("#authservice-login-button").hide(),$("#authservice-login-div").hide(),$("#authservice-forgot-div").show(),$("#authservice-register-button").hide(),$("#authservice-register-div").hide(),!1}),$("#authservice-register-button").click(function(){return $("#authservice-login-button").hide(),$("#authservice-login-div").hide(),$("#authservice-forgot-button").hide(),$("#authservice-forgot-div").hide(),$("#authservice-register-div").show(),!1}),$("#authservice-forgot-cancel").click(authservice.resetLoginMenu),$("#authservice-forgot-ok").click(authservice.resetLoginMenu),$("#authservice-register-cancel").click(authservice.resetLoginMenu),$("#authservice-register-ok").click(authservice.resetLoginMenu),$("#authservice-logout-button").click(function(){authservice.logout()}),$("#authservice-login-submit").click(function(){var e=$("#authservice-login-username").val(),r=$("#authservice-login-password").val();authservice.login(e,r,function(e){authservice.resetLoginMenu()},function(){$("#authservice-login-errmsg").show()})}),$("#authservice-forgot-submit").click(function(){var e=$("#authservice-forgot-username").val();alert("forgot("+e+")");var r=!1;return"ok"==e&&(r=!0),r?($("#authservice-forgot-email2").val(e),$("#authservice-forgot-button").hide(),$("#authservice-forgot-div").hide(),$("#authservice-forgot-done").show(),!1):($("#authservice-forgot-errmsg").show(),!1)}),$("#authservice-register-submit").click(function(){var e=($("#authservice-register-username").val(),$("#authservice-register-password").val()),r=!1;return"ok"==e&&(r=!0),r?($("#authservice-register-button").hide(),$("#authservice-register-div").hide(),$("#authservice-register-done").show(),!1):($("#authservice-register-errmsg").show(),!1)}))},reloadUser:function(t){if(alert("authservice.reloadUser()"),console.log("reloadUser"),null==I){var o=null,n=null,a=!1;u(o,n,a),t&&t(null)}if(B){console.log("reloading dummy data");var o=e(I.username),n=null;return u(o,n,!1),t(o)}r("POST","/getIdentityWithAuthtoken",{ttuat:L,needRelationships:!0,needProperties:!0},x,function(e){if(console.log("back from /getIdentityWithAuthtoken ",e),e&&e.length>0){console.log("User details reloaded.");var r=h(e[0]),o=L,n=!1;u(r,o,n),t&&t(r)}else console.log("Could not reload user. Must have timed out."),u(null,null,n),t&&t(null)},function(e,r,o){console.log("Was not able to reload the user:",e,r,console.error),u(null,null,a),t&&t(null)})},resetLoginMenu:function(){return M&&($("#authservice-login-button").show(),$("#authservice-login-div").show(),$("#authservice-forgot-button").show(),$("#authservice-forgot-div").hide(),$("#authservice-forgot-ok").hide(),$("#authservice-register-button").show(),$("#authservice-register-div").hide(),$("#authservice-register-ok").hide(),$("#authservice-login-username").val(""),$("#authservice-login-password").val(""),$("#authservice-forgot-username").val(""),$("#authservice-register-username").val(""),$("#authservice-register-password").val(""),$("#authservice-user-dropdown").parent().removeClass("open")),!0},getUser:function(e,t){console.log("getUser()"),r("POST","/admin/getUser",e,!0,t)},addRelationship:function(e,t){console.log("addRelationship()"),r("POST","/admin/addRelationship",e,!0,t)},removeRelationship:function(e,t){console.log("removeRelationship()"),r("POST","/admin/removeRelationship",e,!0,t)},addProperty:function(e,t){console.log("addProperty()"),r("POST","/admin/addProperty",e,!0,t)},removeProperty:function(e,t){console.log("removeProperty()"),r("POST","/admin/removeProperty",e,!0,t)},nocomma:null}}(),authservice=Authservice;